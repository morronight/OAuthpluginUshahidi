<?phprequire 'twitter/tmhOAuth.php';require 'twitter/tmhUtilities.php';require_once '../controllers/Utilisateur.php';$action = null;	if(isset($_REQUEST['action']))		$action = $_REQUEST['action'];		$tmhOAuth = new tmhOAuth(array(  'consumer_key'    =>'TWITTER KEY',  'consumer_secret' => 'TWITTER SECRET',));$here = tmhUtilities::php_self();function outputError($tmhOAuth) {  echo 'Error: ' . $tmhOAuth->response['response'] . PHP_EOL;  tmhUtilities::pr($tmhOAuth);}//dcif ($action == 'deconnexion') {		unset($_SESSION['utilisateur']);		unset($_SESSION['access_token']);		unset($_SESSION['twitter_access_token']);		echo '<script language="Javascript">			<!--			document.location.replace("/administration");			// -->			</script>';			exit();	}// reset request?if ( isset($_REQUEST['wipe'])) {  session_destroy();  header("Location: {$here}");// already got some credentials stored?} elseif ( isset($_SESSION['access_token']) ) {  $tmhOAuth->config['user_token']  = $_SESSION['access_token']['oauth_token'];  $tmhOAuth->config['user_secret'] = $_SESSION['access_token']['oauth_token_secret'];  $code = $tmhOAuth->request('GET', $tmhOAuth->url('1/account/verify_credentials'));  if ($code == 200) {  //connecté    $resp = json_decode($tmhOAuth->response['response']);    echo $resp->screen_name;		if(!isset($_SESSION['utilisateur']))		{				$utilisateur = Utilisateur::GetAccesTwitter($resp->id);			if($utilisateur === false)			{				unset($_SESSION['access_token']);				unset($_SESSION['twitter_access_token']);				echo '<h1>Ce compte google+ n\'est associé à aucun compte du site - Redirection en cours...<h1>';				echo '<script language="Javascript">					<!--					document.location.replace("/index.php/login");					// -->					</script>';				exit();			}			else			{				$_SESSION['utilisateur'] = $utilisateur->id;				$_SESSION['habilitation'] = $utilisateur->droits;				echo '<h1>Vous êtes bien connecté ! - Redirection en cours...<h1>';				echo '<script language="Javascript">					<!--					document.location.replace("/index.php/login");					// -->					</script>';				exit();			}		}		else		{			$utilisateur = Utilisateur::Get($_SESSION['utilisateur']);			if($utilisateur->google_id == $resp->id)			{				echo '<h1>Votre compte est déjà associé à un compte google+ - Redirection en cours...<h1>';				echo '<script language="Javascript">					<!--					document.location.replace("/index.php/login");					// -->					</script>';				exit();			}			else				if($utilisateur->UpdateTwitterId($resp->id) === true)				{					echo '</h1>Compte désormais associé à votre compte google+ - Redirection en cours...<h1>';					echo '<script language="Javascript">					<!--					document.location.replace("/index.php/login");					// -->					</script>';					exit();				}				else				{					unset($_SESSION['twitter_access_token']);					echo '<h1>Erreur lors de l\'association à votre compte google+ - Redirection en cours...<h1>';					echo '<script language="Javascript">					<!--					document.location.replace("/index.php/login");					// -->					</script>';					exit();				}		}  } else {    outputError($tmhOAuth);  }// we're being called back by Twitter} elseif (isset($_REQUEST['oauth_verifier'])) {  $tmhOAuth->config['user_token']  = $_SESSION['oauth']['oauth_token'];  $tmhOAuth->config['user_secret'] = $_SESSION['oauth']['oauth_token_secret'];  $code = $tmhOAuth->request('POST', $tmhOAuth->url('oauth/access_token', ''), array(    'oauth_verifier' => $_REQUEST['oauth_verifier']  ));  if ($code == 200) {    $_SESSION['access_token'] = $tmhOAuth->extract_params($tmhOAuth->response['response']);	$_SESSION['twitter_access_token'] = true;    unset($_SESSION['oauth']);    header("Location: {$here}");  } else {    outputError($tmhOAuth);  }// start the OAuth dance} elseif ( isset($_REQUEST['authenticate']) || isset($_REQUEST['authorize']) ) {  $callback = isset($_REQUEST['oob']) ? 'oob' : $here;  $params = array(    'oauth_callback'     => $callback  );  if (isset($_REQUEST['force_write'])) :    $params['x_auth_access_type'] = 'write';  elseif (isset($_REQUEST['force_read'])) :    $params['x_auth_access_type'] = 'read';  endif;  $code = $tmhOAuth->request('POST', $tmhOAuth->url('oauth/request_token', ''), $params);  if ($code == 200) {    $_SESSION['oauth'] = $tmhOAuth->extract_params($tmhOAuth->response['response']);    $method = isset($_REQUEST['authenticate']) ? 'authenticate' : 'authorize';    $force  = isset($_REQUEST['force']) ? '&force_login=1' : '';    $authurl = $tmhOAuth->url("oauth/{$method}", '') .  "?oauth_token={$_SESSION['oauth']['oauth_token']}{$force}";	header("Location: $authurl" );    //echo '<p>To complete the OAuth flow follow this URL: <a href="'. $authurl . '">' . $authurl . '</a></p>';  } else {    outputError($tmhOAuth);  }}?><!--ul>  <li><a href="?authenticate=1">Sign in with Twitter</a></li>  <li><a href="?authenticate=1&amp;force=1">Sign in with Twitter (force login)</a></li>  <li><a href="?authorize=1">Authorize Application (with callback)</a></li>  <li><a href="?authorize=1&amp;oob=1">Authorize Application (oob - pincode flow)</a></li>  <li><a href="?authorize=1&amp;force_read=1">Authorize Application (with callback) (force read-only permissions)</a></li>  <li><a href="?authorize=1&amp;force_write=1">Authorize Application (with callback) (force read-write permissions)</a></li>  <li><a href="?authorize=1&amp;force=1">Authorize Application (with callback) (force login)</a></li>  <li><a href="?wipe=1">Start Over and delete stored tokens</a></li></ul--!>